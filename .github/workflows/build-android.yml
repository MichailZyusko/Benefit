name: Build android-apk && add create GitHub releases

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
  SIGN_KEY_ALIAS: ${{ secrets.SIGN_KEY_ALIAS }}
  SIGN_KEY_PASSWORD: ${{ secrets.SIGN_KEY_PASSWORD }}

jobs:
#  ci:
#    runs-on: ubuntu-latest
#    defaults:
#      run:
#        working-directory: ./mobile
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v3
#
#      - name: Install npm dependencies
#        run: npm ci --force
#
#      - name: Run linter
#        run: echo 'Running linter...'
#
#      - name: Run unit tests
#        run: echo 'Running tests...'

  build-android-apk:
#    needs: [ci]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Checkout keystore repo
        uses: actions/checkout@v2
        with:
          repository: ${{ secrets.KEYSTORE_GIT_REPOSITORY }}
          token: ${{ secrets.KEYSTORE_ACCESS_TOKEN }}
          path: mobile/android/app/keystore

      - name: Setup JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: '11'

      - name: Setup Node JS
        uses: actions/setup-node@master
        with:
          node-version: '16'

      - name: Install npm dependencies
        run: npm ci --force

      - name: Build release APK
        run: |
          cd android && chmod +x ./gradlew && ./gradlew assembleRelease

      - name: Upload APK to artifacts
        uses: actions/upload-artifact@v2
        with:
          name: android-apk
          path: mobile/android/app/build/outputs/apk/release/app-release.apk

#      - name: Get app version
#        run:
#         chmod +x ../.github/workflows/scripts/get-app-version.sh &&
#         ../.github/workflows/scripts/get-app-version.sh
#        shell: bash

  release:
    needs: [build-android-apk]
    runs-on: ubuntu-latest
    steps:
      - name: Download APK from build
        uses: actions/download-artifact@v1
        with:
          name: android-apk

      - name: Log
        run: |
          ls -la
          tree       

      - name: Unzip artifact folder
        uses: montudor/action-zip@v1
        with:
          args: unzip -qq android-apk.zip -d apk

      - name: Log
        run: |
          ls -la
          tree

      - name: Checkout
        uses: actions/checkout@v2

      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          bodyFile: "release/release.md"
#          body: |
#            ## Release Notes
#              ${{ github.event.head_commit.message }}

      - name: Upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: apk/app-release.apk
          asset_name: Benefit.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Log
        run:  echo "${{ steps.create_release.outputs.html_url }}"


#  notify-telegram:
#    needs: build-android-apk
#    runs-on: ubuntu-latest
#    steps:
#      - name: Send-telegram-message-on-new-app-build
#        uses: appleboy/telegram-action@master
#        with:
#          to: ${{ secrets.TELEGRAM_TO }}
#          token: ${{ secrets.TELEGRAM_TOKEN }}
#          disable_web_page_preview: true
#          format: html
#          message: |
#            ðŸŽ‰ðŸŽ‰ðŸŽ‰ <b>Finally!</b> ðŸŽ‰ðŸŽ‰ðŸŽ‰
#
#            Guys, a new version of the app is already available. Check this out!
#
#            <b>Version:</b> ${{ github.ref }}
#            <b>Main changes:</b>
#              <code>${{ github.event.head_commit.message }}</code>
#
#            <b>Download for:</b>
#             - ðŸ¤– <a href="https://github.com/MichailZyusko/Benefit/releases/download/${{ github.ref }}/Benefit.apk">Android</a>
#             - ðŸ“± <a href="https://http.cat/404">iOS</a>!
